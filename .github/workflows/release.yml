name: Release & Publish

on:
  # Automatic publish on push to main (after PR merge)
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'package.json'
      - '!**.md'

  # Automatic release on GitHub releases
  release:
    types: [published]

  # Manual workflow dispatch
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Version bump type (for new release)'
        required: false
        type: choice
        options:
          - patch
          - minor
          - major
        default: 'patch'
      version:
        description: 'Specific version (overrides version_type)'
        required: false
        type: string
      release_notes:
        description: 'Release notes'
        required: false
        default: ''
      dry_run:
        description: 'Dry run (do not actually publish)'
        required: false
        default: false
        type: boolean
      create_release:
        description: 'Create GitHub release'
        required: false
        default: true
        type: boolean

jobs:
  test:
    name: Test & Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

      - name: Build package
        run: npm run build

      - name: Verify package contents
        run: npm pack --dry-run

  release:
    name: Create Release
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.create_release == 'true'
    permissions:
      contents: write
    outputs:
      new_version: ${{ steps.version.outputs.new_version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Install dependencies
        run: npm ci

      - name: Determine new version
        id: version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            NEW_VERSION="${{ github.event.inputs.version }}"
            echo "Using specific version: $NEW_VERSION"
          else
            NEW_VERSION=$(npm version ${{ github.event.inputs.version_type }} --no-git-tag-version --no-commit-hooks | sed 's/^v//')
            echo "Bumped version to: $NEW_VERSION"
          fi
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Update CHANGELOG
        run: |
          NEW_VERSION="${{ steps.version.outputs.new_version }}"
          DATE=$(date +"%Y-%m-%d")
          
          # Create new changelog entry
          cat > temp_changelog.md << EOF
          ## [$NEW_VERSION] - $DATE
          
          ${{ github.event.inputs.release_notes || 'Release via GitHub Actions' }}
          
          EOF
          
          # Prepend to existing changelog
          if [ -f CHANGELOG.md ]; then
            tail -n +3 CHANGELOG.md >> temp_changelog.md
          fi
          mv temp_changelog.md CHANGELOG.md

      - name: Commit and push changes
        run: |
          git add package.json CHANGELOG.md
          git commit -m "chore(release): bump version to ${{ steps.version.outputs.new_version }}"
          git push origin HEAD

      - name: Delete existing tag (if present)
        run: |
          TAG_NAME="v${{ steps.version.outputs.new_version }}"
          echo "Checking for existing tag: $TAG_NAME"
          # Delete remote tag if exists
          git push --delete origin "$TAG_NAME" 2>/dev/null || echo "Remote tag doesn't exist or already deleted"
          # Delete local tag if exists
          git tag -d "$TAG_NAME" 2>/dev/null || echo "Local tag doesn't exist or already deleted"
        continue-on-error: true

      - name: Create GitHub Release
        uses: actions/create-release@v1
        with:
          tag_name: v${{ steps.version.outputs.new_version }}
          release_name: Release v${{ steps.version.outputs.new_version }}
          body: ${{ github.event.inputs.release_notes || 'Release via GitHub Actions' }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-npm:
    name: Publish to npm
    needs: [test]
    runs-on: ubuntu-latest
    if: |
      always() && needs.test.result == 'success' && (
        github.event_name == 'push' ||
        github.event_name == 'release' ||
        (github.event_name == 'workflow_dispatch' && github.event.inputs.dry_run != 'true')
      )
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          registry-url: https://registry.npmjs.org/
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build package
        run: npm run build

      - name: Check if NPM_TOKEN is set
        run: |
          if [ -z "${{ secrets.NPM_TOKEN }}" ]; then
            echo "‚ùå NPM_TOKEN secret is not set!"
            echo "Please add your npm token to repository secrets:"
            echo "1. Go to Settings ‚Üí Secrets and variables ‚Üí Actions"
            echo "2. Add new secret named 'NPM_TOKEN'"
            echo "3. Use your npm authentication token as the value"
            exit 1
          else
            echo "‚úÖ NPM_TOKEN is configured"
          fi

      - name: Publish to npm (Dry Run)
        if: github.event.inputs.dry_run == 'true'
        run: |
          echo "üîç This is a DRY RUN - no actual publishing will occur"
          npm publish --dry-run --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish to npm
        if: github.event.inputs.dry_run != 'true'
        run: |
          echo "üöÄ Publishing to npm..."
          npm publish --access public
          echo "‚úÖ Successfully published to npm!"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  publish-github:
    name: Publish to GitHub Packages
    needs: [test]
    runs-on: ubuntu-latest
    if: |
      always() && needs.test.result == 'success' && (
        github.event_name == 'push' ||
        github.event_name == 'release' ||
        (github.event_name == 'workflow_dispatch' && github.event.inputs.dry_run != 'true')
      )
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          registry-url: https://npm.pkg.github.com/
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build package
        run: npm run build

      - name: Configure package for GitHub Packages
        run: |
          # Create a modified package.json with scoped name for GitHub Packages
          node -e "
            const pkg = require('./package.json');
            pkg.name = '@codernirdesh/digit-to-words-nepali';
            pkg.publishConfig = { registry: 'https://npm.pkg.github.com' };
            require('fs').writeFileSync('./package.json', JSON.stringify(pkg, null, 2));
          "

      - name: Publish to GitHub Packages (Dry Run)
        if: github.event.inputs.dry_run == 'true'
        run: |
          echo "üîç This is a DRY RUN for GitHub Packages - no actual publishing will occur"
          npm publish --dry-run
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish to GitHub Packages
        if: github.event.inputs.dry_run != 'true'
        run: |
          echo "üöÄ Publishing to GitHub Packages..."
          npm publish
          echo "‚úÖ Successfully published to GitHub Packages!"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}